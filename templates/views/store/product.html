{% extends "layout/base.html" %}

{% block title %}ExtremeGaming - {{ product.title }} {% if product.price %}- ${{ product.price.price|price_format }}{% endif %}{% endblock %}

{% block header %}
    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery.timeago.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery.timeago.es.js') }}"></script>
{% endblock %}

{% block body %}
    {% if product['assets'].get('background', False) %}
        <style type="text/css">
            body{
                background: -moz-linear-gradient(top, rgba(28,38,47,0.6) 0%, rgba(28,38,47,0.6) 19%, rgba(28,38,47,0.8) 27%, rgba(28,38,47,0.6) 28%, rgba(28,38,47,0.8) 100%), url("../../static/img/product/{{ product.id }}/{{ product['assets']['background'] }}");
                background: -webkit-linear-gradient(top, rgba(28,38,47,0.6) 0%,rgba(28,38,47,0.6) 19%,rgba(28,38,47,0.8) 27%,rgba(28,38,47,0.6) 28%,rgba(28,38,47,0.8) 100%), url("../../static/img/product/{{ product.id }}/{{ product['assets']['background'] }}");
                background: linear-gradient(to bottom, rgba(28,38,47,0.6) 0%,rgba(28,38,47,0.6) 19%,rgba(28,38,47,0.8) 27%,rgba(28,38,47,0.6) 28%,rgba(28,38,47,0.8) 100%), url("../../static/img/product/{{ product.id }}/{{ product['assets']['background'] }}");
                filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#cc1c262f', endColorstr='#1c262f',GradientType=0 ); /* IE6-9 */
                background-repeat: repeat-x;
                background-attachment: fixed;
                background-size: cover;
            }
        </style>
    {% else %}
        <style type="text/css">
            body{
                background-image: url("../../static/img/blue_body_repeat.jpg");
                background-attachment: fixed;
                background-repeat: no-repeat;
                background-size: cover;
            }
        </style>
    {% endif %}

    <div class="s-commerce-product-container">
        <div class="container">
            <div class="row">
                <div class="col-md-14 col-md-padding col-md-offset-1">
                    <div class="s-commerce-product-top-hud">
                        <span class="s-commerce-product-hud-title">
                            {{ product['title'] }}
                        </span>

                        <span class="s-commerce-product-hud-price pull-right">
                            {% if product['price'] %}
                                ${{ product['price']['price']|price_format }} ARS
                            {% else %}
                                Precio inactivo
                            {% endif %}
                        </span>

                        <div class="s-commerce-product-links">
                            <span class="s-commerce-product-hud-link">
                                <a href="{{ product.get('store_url') }}" target="_blank">Ver en tienda</a>
                            </span>

                            <span class="s-commerce-product-hud-section-link pull-right">
                                <a href="{{ url_for('views.store.store_catalog') }}">{{ product['section']['title'] }}</a>
                            <span>
                        </div>
                    </div>

                    <div class="s-commerce-product-body">
                        <div class="row">
                            <div class="col-md-10">
                                <div class="s-commerce-body-inner">
                                    <div class="s-commerce-description-title">
                                        Descripción
                                    </div>

                                    <div class="s-commerce-product-description">
                                        {{ product['description'] }}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="s-commerce-description-title">
                                    Características
                                </div>

                                <div class="s-commerce-product-specs">
                                    {% for spec in product['specs'] %}
                                        {% if spec['visible'] %}
                                            <span class="s-commerce-spec">
                                                <a href="#">{{ spec['title'] }}</a>
                                            </span>
                                        {% endif %}
                                    {% endfor %}
                                </div>

                                <div class="s-commerce-description-title">
                                    Categorías
                                </div>

                                <div class="s-commerce-product-categories">
                                    <span class="s-commerce-category">
                                        Survival
                                    </span>

                                    <span class="s-commerce-category">
                                        Survival
                                    </span>

                                    <span class="s-commerce-category">
                                        Survival
                                    </span>

                                    <span class="s-commerce-category">
                                        Survival
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if g.user %}
                        <div class="s-commerce-product-view-buttons">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="s-commerce-purchase-button">
                                        {% if product.get('price') %}
                                            Comprar
                                        {% else %}
                                            Precio inactivo
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-8">
                                    <div class="s-commerce-cart-button" data-productid="{{ product.get('id') }}">
                                        Agregar al carrito
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="s-commerce-product-login-button">
                            <a href="#" class="s-commerce-purchase-button">
                                Ingresa con tu cuenta de Steam para comprar
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        jQuery.timeago.settings.allowFuture = true;

       jQuery(document).ready(function() {
            $("span.timeago").timeago();
        });

       {% if product.get('price') %}

           function userrequest_swal(){
                swal({
                    title: "Confirmar compra de {{ product.get('title') }} por ${{ product.get('price').get('price')|price_format }} ARS",
                    text: "Al generar una boleta en nuestro sistema estas expresando tu acuerdo con nuestros <a target=\"_blank\" href=\"#\">Términos y condiciones</a>.",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    cancelButtonText: "Cancelar",
                    showLoaderOnConfirm: true,
                    html: true,
                },
                function(){
                    $.ajax({
                        url: '/ajax/store/userrequest/generate/',
                        type: 'POST',
                        data:{
                            product_id: {{ product.get('id') }}
                        },
                        success: function(data){
                            var json_data = JSON.parse(data);
                            var alert_message = '';

                            {% if product.get('is_promotional') %}
                                var alert_message = '<br><br><b>¡Por favor recuerda reservar este pedido!</b><br>Este pedido debe ser reservado con una imagen del recibo de pago, a través de nuestro <a href="#" target="_blank">sistema de reservas</a>. Al hacer esto te podemos guardar una copia al precio de oferta, ¡de otra manera nos veremos obligados a devolverte el monto abonado!';
                            {% endif %}

                            swal(
                                {
                                    title: '¡Pedido #A-' + json_data['userrequest'] + ' generado!',
                                    text: 'Tu código de barras manual es: <b>' + json_data['bar_code'] + '</b>' + alert_message,
                                    type: 'success',
                                    html: true,
                                    confirmButtonText: 'Ver boleta para imprimir',
                                    cancelButtonText: 'Cerrar',
                                    closeOnConfirm: false,
                                    closeOnCancel: true,
                                    showCancelButton: true,
                                },
                                function(){
                                    window.open('https://www.cuentadigital.com/verfactura.php?id=' + json_data['bar_code'], '_blank');
                                    {% if product.get('is_promotional') %}
                                        swal({title: 'Un recordatorio', text: alert_message, html: true});
                                    {% endif %}
                                }
                            );
                        },
                        error: function(data){
                            var json_data = JSON.parse(data.responseText);

                            if (json_data['status'] == 0) {
                                swal('Error de formulario', 'No hemos podido procesar tu pedido. Por favor refresca el sitio e intenta nuevamente', 'error');
                            } else if (json_data['status'] == 1) {
                                swal('Producto no encontrado', 'No hemos encontrado el producto que has solicitado', 'error');
                            } else if (json_data['status'] == 2) {
                                swal('Producto no disponible', 'El producto que has solicitado ya no se encuentra disponible', 'error');
                            } else if (json_data['status'] == 3) {
                                swal('Precio no disponible', 'No se encuentra un precio activo para el producto solicitado', 'error');
                            } else if (json_data['status'] == 4) {
                                swal('Precio únicamente disponible por créditos', 'No se encuentra un precio de boleta activo para el producto solicitado', 'error');
                            } else if (json_data['status'] == 5 || json_data['status'] == 6) {
                                swal(
                                    'Error con CuentaDigital',
                                    'El sistema no se pudo comunicar con el servicio de terceros para la emisión de boletas. Lamentamos los inconvenientes. Recomendamos intentar nuevamente más tarde.',
                                    'error'
                                );
                            }
                        }
                    });
                });
           }

           function paidrequest_swal(){
                swal({
                    title: "Confirmar compra de {{ product.get('title') }} por ${{ product.get('price').get('price')|price_format }} créditos",
                    text: "Al generar una compra con créditos en nuestro sistema estas expresando tu acuerdo con nuestros <a target=\"_blank\" href=\"#\">Términos y condiciones</a>. <b>Se descontará el monto de ${{ product.get('price').get('price')|price_format }} de créditos de tu usuario</b>",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    cancelButtonText: "Cancelar",
                    confirmButtonText: "Autorizar compra por ${{ product.get('price').get('price')|price_format }}",
                    showLoaderOnConfirm: true,
                    html: true,
                },
                function(){
                    $.ajax({
                        url: '/ajax/store/paidrequest/generate/',
                        type: 'POST',
                        data:{
                            product_id: {{ product.get('id') }}
                        },
                        success: function(data){
                            var json_data = JSON.parse(data);

                            swal({
                                title: 'Pedido #C-' + json_data['paidrequest'] + ' realizado',
                                text: 'En las próximas 1hs a 48hs estaremos procesando tu pedido. En caso de que se haya encontrado en "Entrega Inmediata" entonces se creará una nota con tu código/link de activación en tu pedido.',
                                type: 'success',
                                showCancelButton: true,
                                html: true,
                                cancelButtonText: "Cerrar"
                            });
                        },
                        error: function(data){
                            var json_data = JSON.parse(data.responseText);

                            if (json_data['status'] == 0) {
                                swal('Error de formulario', 'No hemos podido procesar tu pedido. Por favor refresca el sitio e intenta nuevamente', 'error');
                            } else if (json_data['status'] == 1) {
                                swal('Producto no encontrado', 'No hemos encontrado el producto que has solicitado', 'error');
                            } else if (json_data['status'] == 2) {
                                swal('Producto no disponible', 'El producto que has solicitado ya no se encuentra disponible', 'error');
                            } else if (json_data['status'] == 3) {
                                swal('Precio no disponible', 'No se encuentra un precio activo para el producto solicitado', 'error');
                            } else if (json_data['status'] == 4) {
                                swal('Créditos insuficientes', 'No dispones de créditos suficientes para realizar esta acción', 'error');
                            } else if (json_data['status'] == 5) {
                                swal('Producto fuera de stock', 'Se ha agotado el stock del producto solicitado', 'error');
                            }
                        }
                    });
                });
           }

           $('.s-commerce-purchase-button').on('click', function(){
                swal({
                    title: "Comprar {{ product.get('title') }} por ${{ product.get('price').get('price')|price_format }} ARS",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    closeOnConfirm: false,
                    closeOnCancel: false,
                    cancelButtonText: "Generar boleta",
                    html: "true",
                    text: "<style type=\"text/css\">.sweet-alert button.cancel{background-color: #2cb16e !important;}</style>",
                    confirmButtonColor: "#2cb16e",
                    confirmButtonText: "Pagar con créditos"
                },
                function(isConfirmed){
                    if (!isConfirmed){
                        userrequest_swal();
                    } else {
                        paidrequest_swal();
                    }
                });
           });
        {% endif %}

       {% if product.get('price') and product.get('price').get('price_type') != 2 %}
           $('.to-complete').on('click', function(){

            });
        {% endif %}

        {% if product.get('price') and (user.money + user.wallet) >= product.get('price').get('price') %}
            $('.v5-credit-invoice').on('click', function(){

            });
        {% endif %}
    </script>
{% endblock %}